{% extends "base.html" %}
{% load static %}

{% block title %}Book Your Session â€“ Inkspire Studio{% endblock %}

{% block content %}

<!-- Page Header -->
<header class="page-header-new">
  <div class="header-bg"></div>
  <div class="header-content">
    <h1>Book Your Session</h1>
    <div class="divider"></div>
    <p>Ready to get started? Fill out the form below and we'll get back to you within 24 hours.</p>
  </div>
</header>

<section class="section">
  <div class="container">

    <form class="booking-form" id="bookingForm" method="post" enctype="multipart/form-data">
      {% csrf_token %}

      <!-- Non-field errors -->
      <div class="form-error" style="color: red; margin-bottom: 15px;">
        {{ form.non_field_errors }}
      </div>

      <!-- Full Name -->
      <div class="form-group">
        <label for="id_name">Full Name *</label>
        {{ form.name }}
        <small class="error-message" style="color:red;"></small>
      </div>

      <!-- Email -->
      <div class="form-group">
        <label for="id_email">Email Address *</label>
        {{ form.email }}
        <small class="error-message" style="color:red;"></small>
      </div>

      <!-- Phone -->
      <div class="form-group">
        <label for="id_phone">Phone Number *</label>
        {{ form.phone }}
        <small class="error-message" style="color:red;"></small>
      </div>

      <!-- Artist -->
      <div class="form-group">
        <label for="id_artist">Preferred Artist</label>
        {{ form.artist }}
      </div>

      <!-- Placement -->
      <div class="form-group">
        <label for="id_placement">Tattoo Placement</label>
        {{ form.placement }}
      </div>

      <!-- Description -->
      <div class="form-group">
        <label for="id_description">Tattoo Description</label>
        {{ form.description }}
        <small class="error-message" style="color:red;"></small>
      </div>

      <!-- Reference Images -->
      <div class="form-group">
        <label for="reference">Upload Reference Images</label>
        <div class="file-input-wrapper">
          <input type="file" id="reference" name="reference" multiple accept="image/*" />
          <label for="reference" class="file-input-label">
            <i class="fas fa-cloud-upload-alt"></i> Click to upload reference images
          </label>
        </div>
      </div>

      <!-- Date -->
      <div class="form-group">
        <label for="id_date">Preferred Date</label>
        {{ form.date }}
      </div>

      <!-- Hidden terms field -->
      <input type="hidden" id="termsAccepted" name="termsAccepted" value="false">

      <button type="submit" class="btn btn-primary" style="width:100%; margin-top:20px;">
        Reserve Your Ink
      </button>
    </form>

  </div>
</section>

<!-- Terms Modal -->
<div id="termsModal" class="modal" role="dialog" aria-modal="true">
  <div class="modal-content">
    <span class="close-btn" id="closeTerms">&times;</span>
    <h2 style="color: var(--gold); text-align:center;">Terms and Conditions</h2>
    <div class="modal-text">
      <p><strong>Welcome to Inkspire Studio.</strong> Please read these terms...</p>
      <p><strong>1. Consultations & Design</strong> ...</p>
      <p><strong>2. Health & Safety</strong> ...</p>
      <p><strong>3. Cancellations & Rescheduling</strong> ...</p>
      <p><strong>4. Deposits & Payments</strong> ...</p>
      <p><strong>5. Aftercare</strong> ...</p>
      <p><strong>6. Liability</strong> ...</p>
      <p><strong>7. Intellectual Property</strong> ...</p>
      <p><strong>8. Age Restrictions</strong> ...</p>
    </div>
    <label class="agree-section">
      <input type="checkbox" id="agreeCheckbox"> I agree to the Terms & Conditions.
    </label>
    <button id="acceptBtn" class="btn-accept" disabled>Accept</button>
  </div>
</div>

<!-- Success Popup -->
<div id="successPopup" class="success-popup">
  <div class="popup-content">
    <span id="closePopup" class="close-popup">&times;</span>
    <h3>Booking Submitted!</h3>
    <p>Your session request has been received. We will contact you soon.</p>
    <button id="okBtn" class="btn-popup">OK</button>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function() {
  const form = document.getElementById('bookingForm');
  const modal = document.getElementById("termsModal");
  const agreeCheckbox = document.getElementById("agreeCheckbox");
  const acceptBtn = document.getElementById("acceptBtn");
  const termsAccepted = document.getElementById("termsAccepted");

  const successPopup = document.getElementById('successPopup');
  const closePopup = document.getElementById('closePopup');
  const okBtn = document.getElementById('okBtn');

  // Terms modal
  acceptBtn.addEventListener('click', () => {
    termsAccepted.value = "true";
    modal.style.display = "none";
    document.body.style.overflow = 'auto';
  });
  agreeCheckbox.addEventListener('change', () => acceptBtn.disabled = !agreeCheckbox.checked);
  document.getElementById("closeTerms").addEventListener('click', () => {
    modal.style.display = "none"; document.body.style.overflow = 'auto';
  });

  window.addEventListener("click", e => {
    if(e.target === modal){ modal.style.display = "none"; document.body.style.overflow = 'auto'; }
  });

  window.addEventListener("keydown", e => {
    if(e.key === "Escape" && modal.style.display === "flex"){
      modal.style.display = "none"; document.body.style.overflow = 'auto';
    }
  });

  // Success popup close
  closePopup.addEventListener('click', () => successPopup.style.display = 'none');
  okBtn.addEventListener('click', () => successPopup.style.display = 'none');

  // AJAX form submit
  form.addEventListener('submit', function(e) {
    e.preventDefault();

    // Validate terms
    if(termsAccepted.value !== "true"){
      modal.style.display = "flex";
      document.body.style.overflow = 'hidden';
      return;
    }

    const formData = new FormData(form);

    fetch("", {
      method: "POST",
      headers: {"X-Requested-With":"XMLHttpRequest"},
      body: formData
    })
    .then(res => res.json())
    .then(data => {
      // Clear previous errors
      document.querySelectorAll('.error-message').forEach(el => el.innerText = '');

      if(data.success){
        successPopup.style.display = 'flex';
        form.reset();
        const fileInput = document.getElementById('reference');
        if(fileInput) fileInput.value = '';
        termsAccepted.value = "false";
        agreeCheckbox.checked = false;
        acceptBtn.disabled = true;
      } else if(data.errors){
        for(const field in data.errors){
          const errorEl = document.querySelector(`#id_${field} ~ .error-message`);
          if(errorEl) errorEl.innerText = data.errors[field][0];
        }
      }
    })
    .catch(err => console.error(err));
  });

});
</script>
{% endblock %}
